{% extends 'Retailer/base.html.twig' %}

{% block title %}Adicionar Cotação{% endblock %}
{% block description %}{% endblock %}
{% block menu_pricelist %} active {% endblock %}

{% block page_plugins %}
    <link href="{{ asset('assets/global/plugins/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css') }}" rel="stylesheet" type="text/css" />
    <link href="{{ asset('assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css') }}" rel="stylesheet" type="text/css" />

{% endblock %}

{% block page %}
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <style>
        .ProgressBar {
            margin: 0 auto;
            /*  padding: 2em 0 3em;*/
            list-style: none;
            position: relative;
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-pack: justify;
            -ms-flex-pack: justify;
            justify-content: space-between;
            width: auto !important;
        }

        .ProgressBar-step {
            text-align: center;
            position: relative;
            width: 100%;
        }
        .ProgressBar-step:before, .ProgressBar-step:after {
            content: "";
            height: 0.2em;
            background-color: #40AE40;;
            position: absolute;
            z-index: 1;
            width: 100%;
            left: -50%;
            top: 50%;
            -webkit-transform: translateY(-50%);
            transform: translateY(-50%);
            -webkit-transition: all .25s ease-out;
            transition: all .25s ease-out;

        }
        .ProgressBar-step:first-child:before, .ProgressBar-step:first-child:after {
            display: none;
        }
        .ProgressBar-step:after {
            background-color: #40AE40;
            border:1px solid #40AE40;
            width: 0;
        }
        .ProgressBar-step.is-complete + .ProgressBar-step.is-current:after, .ProgressBar-step.is-complete + .ProgressBar-step.is-complete:after {
            width: 100%;
        }

        .ProgressBar-icon {
            width: 2.0em;
            height: 2.0em;
            background-color: #319431;
            fill: #319431;
            border-radius: 50%;
            padding: 0.5em;
            max-width: 100%;
            z-index: 10;
            position: relative;
            margin-top: 4px;
            -webkit-transition: all .25s ease-out;
            transition: all .25s ease-out;
            border:2px solid #40AE40
        }
        .is-current .ProgressBar-icon {
            fill: yellow;
            background-color: yellow;
        }
        .is-complete .ProgressBar-icon {
            fill: #fff;
            background-color: #40AE40;
        }

        .ProgressBar-stepLabel {
            display: block;
            text-transform: uppercase;
            color: #9F9FA3;
            position: absolute;
            padding-top: 0.5em;
            width: 100%;
            -webkit-transition: all .25s ease-out;
            transition: all .25s ease-out;
        }
        .is-current > .ProgressBar-stepLabel, .is-complete > .ProgressBar-stepLabel {
            color: #00637C;
        }


        /*
        Float label styles
         */
        label:hover {
            cursor: text;
        }

        @media (max-width: 500px) {
            .contact-form {
                margin: 0 0 100px;
                width: 100%;
            }
        }
        .contact-form .email, .contact-form .message, .contact-form .text {
            position: relative;
        }
        .contact-form .email input:focus, .contact-form .email textarea:focus, .contact-form .message input:focus, .contact-form .message textarea:focus, .contact-form .text input:focus, .contact-form .text textarea:focus {
            background: #f4f5f6;
        }
        .contact-form .email label, .contact-form .message label, .contact-form .text label {
            color: #40AE40;
            left: 23px;
            position: absolute;
            top: 13px;
            -moz-transition: all, 150ms;
            -o-transition: all, 150ms;
            -webkit-transition: all, 150ms;
            transition: all, 150ms;
        }
        .contact-form .email.typing label, .contact-form .message.typing label, .contact-form .text.typing label {
            color: #40ae40;
            font-size: 10px;
            top: 2px;
        }

        .text input, .text select {
            margin: 0 auto;
            height: 44px;
            padding-top: 14px;
            width: 95%;
            border: 1px solid #40AE40
        }
        .text input:focus, .text select:focus{
            border: 1px solid #40AE40;
        }

        .contact-form .email {
            border-left: 1px #e6e6e6 solid;
            float: right;
        }
        @media (max-width: 500px) {
            .contact-form .email {
                border-left: none;
                border-top: 1px #e6e6e6 solid;
            }
        }
        .contact-form .message {
            border-bottom: 1px #e6e6e6 solid;
            border-top: 1px #e6e6e6 solid;
            clear: both;
        }
        .contact-form .message textarea {
            height: 200px;
            padding: 23px;
        }
        .contact-form .text {
            float: none;
        }
        .navbar-inner {
            background: #319431;
            width: 100%;
        }

        #rootwizard{
            background: #fff;
        }

        .wizard-container{
            padding: 12px 20px 15px;
            border-top-width: 1px;
        }

        .mt-checkbox.mt-checkbox-outline:hover>input:not([disabled]):checked ~ span, .mt-checkbox.mt-checkbox-outline>input:checked ~ span {

            background: #319431 !important;
            border-radius: 2px;
            border: 1px solid #319431;

        }

        .mt-checkbox.mt-checkbox-outline>span {
            border: 1px solid #d9d9d9;
            background: 0;
            border-radius: 2px;
            cursor: pointer;
        }
        .mt-checkbox>span:after {
            left: 6px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid #fff;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .error {
            border: 1px solid red !important;
        }

        .valid {
            border: 1px solid #40AE40 !important;
        }

        .nav-pills>li.active>a, .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus {
            color: transparent;
            background-color: transparent;
        }

        .nav>li>a:hover, .nav>li>a:focus {
            text-decoration: none;
            background-color: transparent;
        }
        .disabled-click {
            pointer-events: none;
            cursor: default;
        }
        td {
            text-align: center;
            vertical-align: middle;
        }
        th {
            text-align: center;
            vertical-align: middle;
        }
        .dataTables_filter{

            padding-right: 40px;

        }
        .datatable-plus-button{
            padding-top: 5px;
            top: 14px;
            padding-bottom: 5px;
            padding-right: 9px;
            background: #40AE40;
        }

        .datatable-plus-button::before {
            font-family: fontAwesome;
            content: "\f067\00a0";
            color: white;
            background-color: transparent;
        }

        .text-area{
            width: 95%;
            border: 1px solid #40AE40;
            padding-top: 14px;
            resize: vertical;
            margin-left: 2.5%;
        }

        .text select {
            margin: 0 auto;
            height: 44px;
            padding-top: 14px;
            width: 95%;
            border: 1px solid #40AE40;
        }
        .text select:focus{
            border: 1px solid #40AE40;
        }
        .modal .modal-header{
            background-color: #40AE40;
        }
        .modal-title{
            color: #FFFFFF;
        }

        .ui-autocomplete {
            z-index: 100000;
        }
    </style>

    <div class="page-wrapper-row full-height">
        <div class="page-wrapper-middle">
            <!-- BEGIN CONTAINER -->
            <div class="page-container">
                <!-- BEGIN CONTENT -->
                <div class="page-content-wrapper">
                    <!-- BEGIN CONTENT BODY -->
                    <!-- BEGIN PAGE HEAD-->
                    <div class="page-head">
                        <div class="container">
                            <!-- BEGIN PAGE TITLE -->
                            <div class="page-title">
                                <h1>Cotação
                                    <small>Complete os passos abaixo para criar a sua cotação</small>
                                </h1>
                            </div>
                            <!-- END PAGE TITLE -->
                        </div>
                    </div>
                    <!-- END PAGE HEAD-->
                    <!-- BEGIN PAGE CONTENT BODY -->
                    <div class="page-content">
                        <div class="container">
                            {% include '_partial/flashMessages.html.twig' %}
                            <!-- BEGIN PAGE BREADCRUMBS -->
                            <ul class="page-breadcrumb breadcrumb">
                                <li>
                                    <a href="{{ path('dashboard') }}">Painel Inicial</a>
                                    <i class="fa fa-circle"></i>
                                </li>
                                <li>
                                    <a href="{{ path('cotacoes') }}">Cotações</a>
                                    <i class="fa fa-circle"></i>
                                </li>
                                <li>
                                    <span>Criar Cotação</span>
                                </li>
                            </ul>
                            <!-- END PAGE BREADCRUMBS -->
                            <!-- BEGIN PAGE CONTENT INNER -->
                            <div class="page-content-inner">
                                {{ include('Retailer/pricelist/quoteWizzard.html.twig') }}
                            </div>
                            <!-- END PAGE CONTENT INNER -->
                        </div>
                    </div>
                    <!-- END PAGE CONTENT BODY -->
                    <!-- END CONTENT BODY -->
                </div>
                <!-- END CONTENT -->
            </div>
            <!-- END CONTAINER -->
        </div>
    </div>

    <svg style="display:none" xmlns="http://www.w3.org/2000/svg">
        <symbol id="checkmark-bold" viewBox="0 0 24 24">
            <path d="M20.285 2l-11.285 11.567-5.286-5.011-3.714 3.716 9 8.728 15-15.285z"/>
        </symbol>
    </svg>
{% endblock %}

{% block script %}
    <script src="{{ asset('assets/global/plugins/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('assets/global/plugins/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.pt-BR.js') }}" type="text/javascript" charset="UTF-8"></script>
    <script src="{{ asset('assets/global/plugins/bootstrap-wizard/jquery.bootstrap.wizard.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('assets/global/scripts/datatable.js') }}" type="text/javascript"></script>
    <script src="{{ asset('assets/global/plugins/datatables/datatables.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('assets/global/plugins/jquery-validation/js/jquery.validate.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('assets/global/plugins/jquery-validation/js/localization/messages_pt_BR.min.js') }}" type="text/javascript"></script>
    <script src="{{ asset('assets/pages/scripts/jquery.mask.min.js') }}" type="text/javascript"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script>
        var supplierTable = $('#supplier-datatable');
        var listingTable = $('#listing-datatable');
        var productTable = $('#product-datatable');
        var nowDate = new Date();
        var minDate = new Date(nowDate.getFullYear(), nowDate.getMonth(), nowDate.getDate(), nowDate.getHours(), nowDate.getMinutes()-15);

        //BEGIN MASKS

        $(function(){
            $('#cnpj').mask('00.000.000/0000-00');
            $('#valor_minimo').mask('000.000.000.000.000,00', {reverse: true});
            $('#codigo').mask('00000000000000000');
            $('input').each(function() {
                if($(this).val() == '') {
                    $(this).parent('div:first').removeClass('typing');
                } else {
                    $(this).parent('div:first').addClass('typing');
                }
            });
            $('tbody input[type=checkbox]').click(function() {
                let table = $(this).parents('table:first');

                let inputs = table.find('tbody input[type=checkbox]:visible');
                let inputsChecked = inputs.filter(':checked');

                let checkar = (inputs.length == inputsChecked.length);

                table.find('thead input[type=checkbox]:visible').prop('checked', checkar);
            });
            $('#product-datatable tbody tr input[type="checkbox"]:checked').each(function() {
                $(this).parents('tr:first').removeClass('hidden');
            });
        });

        $('input.quantidade').change(function() {
            let value = $(this).val();

            if(!$.isNumeric(value)) {
                $(this).val(1);
                return;
            }

            if(value < 1) {
                $(this).val(1);
                return;
            }

            if(value > 2147483646) { //MAX INT
                $(this).val(2147483646);
            }
        });

        var SPMaskBehavior = function (val) {
                return val.replace(/\D/g, '').length === 11 ? '(00) 00000-0000' : '(00) 0000-00009';
            },
            spOptions = {
                onKeyPress: function(val, e, field, options) {
                    field.mask(SPMaskBehavior.apply({}, arguments), options);
                }
            };

        $('#telefone_representante').mask(SPMaskBehavior, spOptions);
        $('#celular_representante').mask(SPMaskBehavior, spOptions);

        function changeChkProduct() {
            $('#product-datatable').DataTable().search('').draw();
            $('#product-datatable tbody tr input[type="checkbox"]:not(:checked)').each(function() {
                $(this).parents('tr:first').addClass('hidden');
            });
        }

        function changeChkSupplier() {
            let $this = $(this);
            let checked = $this.prop('checked');
            let id = $this.val();
            let check = $('#sendSuppliersTable tbody input[value='+id+']');

            if(checked) {
                let row = $this.parents('tr:first');

                if(check.length == 0) {
                    let tr = $('<tr></tr>');
                    let input = "<label class='mt-checkbox mt-checkbox-outline'><input type='checkbox' name='chkSendSupplier' value='"+id+"' checked/><span></span></label>";

                    tr.append($('<td>'+input+'</td>'));
                    tr.append($('<td>'+row.find('.rep-name').text()+'</td>'));
                    tr.append($('<td>'+row.find('.rep-email').text()+'</td>'));

                    $('#sendSuppliersTable tbody').append(tr);
                }
            } else {
                if(check.length > 0) {
                    check.parents('tr:first').remove();
                }
            }
        };

        //END MASKS


        var token = "{{ token }}";

        {% if userIsRCA %}
            {% if prazoManual == '' %}
                $("#prazo").hide();
            {% endif %}
        $("#prazoRCA").change(function() {
            if($(this).val() == "Outros")
                $('#prazo').show();
            else
                $('#prazo').hide();
        });
        {% endif %}

        $(function () {
            $('#beginsAtTimePicker').datetimepicker({
                format: 'dd/mm/yyyy hh:ii',
                language: 'pt-BR'
            });
            $('#expiresAtTimePicker').datetimepicker({
                format: 'dd/mm/yyyy hh:ii',
                language: 'pt-BR'
            });
        });

        function setItensSuplliers(id,elementId) {
            var count = 0;

            $.each($("#" + id + " tbody tr").find("input"), function(index, value) {
                if($(this)["0"].checked) {
                    count = count + 1
                }
            });
            $("#" + elementId).text(count);
        }

        function setDateTime(id,elementId,format){
            var formatted;
            var date = $("#"+id).data("datetimepicker").getDate();

            if (format === "date") {
                formatted = " " +  set2Digits(date.getDate()) + "/" + set2Digits(date.getMonth() + 1) + "/" +  date.getFullYear();
            } else {
                formatted = " " +   set2Digits(date.getHours()) + ":" + set2Digits(date.getMinutes()) ;
            }

            $("#" + elementId ).text(formatted);
        }

        function stepFoward($bar) {
            if ($bar.children(".is-current").length > 0) {
                $bar.children(".is-current").removeClass("is-current").addClass("is-complete").next().addClass("is-current");
            } else {
                $bar.children().first().addClass("is-current");
            }
        }

        function selectAll(topCheck, checks) {
            $("[name='" + topCheck + "']").click(function() {
                let state = $(this).prop('checked');
                let checkBoxes = $("[name='" + checks + "']:visible");
                checkBoxes.prop("checked", state);
            })
        }

        function createDate(valor) {
            if(valor == '')
                return false;

            let partes = valor.split(' ');
            let date = partes[0].split('/');
            let hora = partes[1].split(':');

            return new Date(date[2], date[1] - 1, date[0], hora[0], hora[1]);
        }

        function validateForm() {
            var validationState = $('#cotacao_form').valid();
            let btnNext = $("#advance").find("a");

            if(validationState) {
                let begins = createDate($('#beginsAtTimePicker').val());
                let expires = createDate($('#expiresAtTimePicker').val());

                {% if quote is not defined %}
                    if(begins <= minDate) {
                        btnNext.addClass('disabled');
                        $('#beginsAtTimePicker').removeClass('valid');
                        $('#beginsAtTimePicker').addClass('error');
                        return;
                    } else {
                        $('#beginsAtTimePicker').removeClass('error');
                        $('#beginsAtTimePicker').addClass('valid');
                    }
                {% endif %}

                if(begins < expires) {
                    btnNext.removeClass('disabled');
                    $('#expiresAtTimePicker').removeClass('error');
                    $('#expiresAtTimePicker').addClass('valid');
                } else {
                    btnNext.addClass('disabled');
                    $('#expiresAtTimePicker').removeClass('valid');
                    $('#expiresAtTimePicker').addClass('error');
                }
            } else {
                btnNext.addClass('disabled');
            }
        }

        function checkaStep1() {
            if(supplierTable.find('tr').find("input").is(":checked")){
                $("#advance").find("a").removeClass('disabled');
                return;
            }
            $("#advance").find("a").addClass('disabled');
        }

        function checkaStep3() {
            if( productTable.find('tr').find("input").is(":checked") ){
                $("#advance").find("a").removeClass('disabled');
                return;
            }
            $("#advance").find("a").addClass('disabled');
        }

        $(document).ready(function() {
            //BEGIN WIZARD METHODS
            $('#rootwizard').bootstrapWizard({onTabShow: function(tab, navigation, index) {
                var currentStep = navigation.find('li');
                currentStep.removeClass("active");

                switch(index) {
                    case 0 :
                        $("#wizardStepLabel").text(" Dados da Cotação");
                        $("#wizardStepImage").attr("src","{{ asset('assets/global/img/icons/dados-da-cotacao/24x24.png') }}");
                        $("#advance a").addClass('disabled');
                        $("#previous").hide();

                        //BEGIN FORM VALIDATION
                        var cotacaoForm = $( "#cotacao_form" );

                        cotacaoForm.validate({
                            errorPlacement: function(){
                                return false;
                            }
                        });

                        validateForm();
                        cotacaoForm.mouseout(validateForm);
                        cotacaoForm.change(validateForm);
                        cotacaoForm.keydown(validateForm);
                        cotacaoForm.keyup(validateForm);
                        //END FORM VALIDATION
                        break;
                    case 1 :
                        $("#wizardStepLabel").text(" Selecionar Fornecedor");
                        $("#wizardStepImage").attr("src","{{ asset('assets/global/img/icons/fornecedores/24x24.png') }}");
                        $("#advance a").addClass('disabled');
                        $("#previous").show();

                        checkaStep1()
                        supplierTable.find('input').change(checkaStep1);

                        break;
                    case 2 :
                        $("#wizardStepLabel").text(" Selecionar Lista");
                        $("#wizardStepImage").attr("src","{{ asset('assets/global/img/icons/minhas-listas/24x24.png') }}");
                        $("#advance a").removeClass('disabled');

                        break;
                    case 3 :
                        $("#wizardStepLabel").text(" Selecionar Produtos");
                        $("#wizardStepImage").attr("src","{{ asset('assets/global/img/icons/produtos/24x24.png') }}");
                        $("#advance a").addClass('disabled');
                        $("#advance").show();

                        checkaStep3();
                        productTable.find('input').change(checkaStep3);

                        break;
                    case 4 :
                        $("#wizardStepLabel").text(" Confirmação dos Dados");
                        $("#wizardStepImage").attr("src","{{ asset('assets/global/img/icons/confirmacao-dos-dados/24x24.png') }}");
                        $("#advance").hide();
                        setDateTime("beginsAtTimePicker","quote_start","date");
                        setDateTime("beginsAtTimePicker","quote_start_time","time");
                        setDateTime("expiresAtTimePicker","quote_end","date");
                        setDateTime("expiresAtTimePicker","quote_end_time","time");
                        setItensSuplliers("product-datatable","quote_itens");
                        setItensSuplliers("supplier-datatable","quote_suppliers");
                        if($('#prazoRCA').length && $('#prazoRCA').val() != 'Outros') {
                            $('#quote_due_date').text($('#prazoRCA').val());
                        } else {
                            $('#quote_due_date').text($('#prazo').val());
                        }
                        break;
                }
            }});
        });

        $("#advance").on("click", function() {
            var $bar = $(".ProgressBar");
            stepFoward($bar);
        });

        $("#previous").on("click", function() {
            var $bar = $(".ProgressBar");
            if ($bar.children(".is-current").length > 0) {
                $bar.children(".is-current").removeClass("is-current").prev().removeClass("is-complete").addClass("is-current");
            } else {
                $bar.children(".is-complete").last().removeClass("is-complete").addClass("is-current");
            }
        });

        //END WIZARD METHODS

        $('#beginsAtTimePicker').change(function(){
            $('.beginsAtTimePicker.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.beginsAtTimePicker.text').removeClass('typing');
            }
        });

        $('.beginsAtTimePicker.text').addClass('typing');

        $('#expiresAtTimePicker').change(function(){
            $('.expiresAtTimePicker.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.expiresAtTimePicker.text').removeClass('typing');
            }
        });

        //cotacao field default value
        var d = new Date();

        var month = d.getMonth()+1;
        var day = d.getDate();
        var hours = d.getHours()
        var minutes = d.getMinutes()

        {% if quote is not defined %}
            var output = "Cotação " + ((''+day).length<2 ? '0' : '') + day + '/' +
                ((''+month).length<2 ? '0' : '') + month + ", " +
                hours + ":" + minutes;

            $("#cotacao").val(output);
        {% endif %}
        $('.cotacao.text').addClass('typing');

        //BEGIN FLOAT LABEL METHODS
        $('#cotacao').keyup(function(){
            $('.cotacao.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.cotacao.text').removeClass('typing');
            }
        });

        $('#beginsAtTimePicker').keyup(function(){
            $('.beginsAtTimePicker.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.beginsAtTimePicker.text').removeClass('typing');
            }
        });

        $('#expiresAtTimePicker').keyup(function(){
            $('.expiresAtTimePicker.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.expiresAtTimePicker.text').removeClass('typing');
            }
        });

        $('#prazo').keyup(function(){
            $('.prazo.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.prazo.text').removeClass('typing');
            }
        });

        $('#fornecedor').keyup(function(){
            $('.fornecedor.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.fornecedor.text').removeClass('typing');
            }
        })

        $('#cnpj').keyup(function(){
            $('.cnpj.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.cnpj.text').removeClass('typing');
            }
        })

        $('#valor_minimo').keyup(function(){
            $('.valor_minimo.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.valor_minimo.text').removeClass('typing');
            }
        })

        $('#representante').keyup(function(){
            $('.representante.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.representante.text').removeClass('typing');
            }
        })

        $('#email_representante').keyup(function(){
            $('.email_representante.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.email_representante.text').removeClass('typing');
            }
        })

        $('#telefone_representante').keyup(function(){
            $('.telefone_representante.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.telefone_representante.text').removeClass('typing');
            }
        })

        $('#celular_representante').keyup(function(){
            $('.celular_representante.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.celular_representante.text').removeClass('typing');
            }
        })

        $('#lista').keyup(function(){
            $('.lista.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.lista.text').removeClass('typing');
            }
        })

        $('#descricao').keyup(function(){
            $('.descricao.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.descricao.text').removeClass('typing');
            }
        })

        $('#tipo').keyup(function(){
            $('.tipo.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.tipo.text').removeClass('typing');
            }
        })

        $('#produto').keyup(function(){
            $('.produto.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.produto.text').removeClass('typing');
            }
        })

        $("#produto").autocomplete({
            source: function(request, response) {
                $.ajax({
                    url: "{{ path('ajax_produtos') }}",
                    dataType: "json",
                    data: {
                        term: request.term
                    },
                    success: function(data) {
                        response(data);
                    }
                });
            },
            minLength: 3
        });

        $("#produto").on( "autocompleteselect", function( event, ui ) {
            $('#codigo').val(ui.item.ean);
            $('#marca').val(ui.item.brand);
            $('#peso').val(ui.item.quantity);
            $('#tipo-produto').val(ui.item.type);
            $('#unidade').val(ui.item.unit);
            $('#descricao-produto').val(ui.item.full_description);

            $('.codigo.text').addClass('typing');
            $('.marca.text').addClass('typing');
            $('.peso.text').addClass('typing');
            $('.descricao-produto.text').addClass('typing');
        } );

        $('#codigo').keyup(function(){
            $('.codigo.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.codigo.text').removeClass('typing');
            }
        })

        $('#marca').keyup(function(){
            $('.marca.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.marca.text').removeClass('typing');
            }
        })

        $('#peso').keyup(function(){
            $('.peso.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.peso.text').removeClass('typing');
            }
        })

        $('#descricao-produto').keyup(function(){
            $('.descricao-produto.text').addClass('typing');
            if( $(this).val().length == 0 ) {
                $('.descricao-produto.text').removeClass('typing');
            }
        })
        //END FLOAT LABEL METHODS

        $('[name=selectAllListing]').click(function() {
            let state = $(this).prop('checked');
            $('[name=selectAllProducts]').prop('checked', state);
            $('[name=chkProducts]').prop('checked', state);

            if(state)
                $('#product-datatable tbody tr').removeClass('hidden');
            else
                $('#product-datatable tbody tr').addClass('hidden');
        });
        $('[name=chkListing]').click(function() {
            let state = $(this).prop('checked');

            $('[name=chkProducts]').prop('checked', false);

            let ids = [];
            $('[name=chkListing]:checked').each(function(index, input) {
                let partial = $(input).data('products');
                ids = ids.concat(partial);
            });

            $(ids).each(function(index, id) {
                let check = $('[name=chkProducts][value='+id+']');
                check.prop('checked', state);
                if(state)
                    check.parents('tr:first').removeClass('hidden');
                else
                    check.parents('tr:first').addClass('hidden');
            });
        });

        // BEGIN Supplier TABLE
        $('#supplier-datatable').dataTable( {
            autoWidth: false,
            responsive: true,
            language: {
                "sEmptyTable": "Nenhum registro encontrado",
                "sInfo": "Mostrando de _START_ até _END_ de _TOTAL_ registros",
                "sInfoEmpty": "Mostrando 0 até 0 de 0 registros",
                "sInfoFiltered": "(Filtrados de _MAX_ registros)",
                "sInfoPostFix": "",
                "sInfoThousands": ".",
                "sLengthMenu": "_MENU_ resultados por página",
                "sLoadingRecords": "Carregando...",
                "sProcessing": "Processando...",
                "sZeroRecords": "Nenhum registro encontrado",
                "sSearch": "Pesquisar",
                "oPaginate": {
                    "sNext": '<i class="fa fa-angle-right"></i>',
                    "sPrevious": '<i class="fa fa-angle-left"></i>',
                },
                "oAria": {
                    "sSortAscending": ": Ordenar colunas de forma ascendente",
                    "sSortDescending": ": Ordenar colunas de forma descendente"
                }
            },
            lengthMenu: [ [10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"] ],
            iDisplayLength: -1,
            dom: '<"top"<"pull-left"l><"pull-right"fB>><"table-scrollable"t><"bottom"ip><"clear">',
            buttons: [
                {
                    text: '',
                    className: 'datatable-plus-button add-supplier green-conecta',
                    action: function ( e, dt, node, config ) {

                        $('#myModal').modal('toggle');

                    }

                }
            ],
            initComplete: function(){

            }
        });


        $('#salvar_fornecedor').on('click', function() {
            var $this = $(this);

            var name = $('#fornecedor').val();
            var cnpj = $('#cnpj').val();

            var minimum_value = null;

            if($('#valor_minimo').val() !== ""){
                minimum_value = $('#valor_minimo').val()
            }

            var contact_name = $('#representante').val();
            var contact_phone = $('#telefone_representante').val();
            var contact_email = $('#email_representante').val();

            var supplierForm = $( "#supplier_form" );

            $( "#supplier_form" ).validate({
                errorPlacement: function(){
                    return false;
                }

            });
            var validationState = supplierForm.valid();

            if(validationState) {

                $.ajax(
                    {
                        url: "{{ path('post_api_representative') }}",
                        type: 'POST',
                        contentType: "application/json",
                        dataType: "json",
                        headers: {'Api-Token': token},
                        data:  JSON.stringify({
                            name: name,
                            cnpj: cnpj,
                            minimum_value: minimum_value,
                            contact_name: contact_name,
                            contact_phone: contact_phone,
                            contact_email: contact_email
                        }),
                        success: function (response) {
                            console.log(response);
                            $('#supplier-datatable').DataTable().row.add([
                                "<label class='mt-checkbox mt-checkbox-outline'><input type='checkbox' value='"+response.supplier_id+"' name='chkSupplier' data-suppid='"+ response.supplier_id +"' onchange='changeChkSupplier.call(this);'/><span></span></label>",
                                response.name,
                                response.contact_name,
                                response.contact_email,
                                response.cnpj,
                                response.contact_phone
                            ]).draw();
                            $('#myModal').modal('toggle');
                            $("#supplier_form").trigger("reset");
                            $("#supplier_form div").removeClass('typing');
                        },
                        error: function (error) {
                            alert(error.responseJSON.error.exception["0"].message);
                            $('#myModal').modal('toggle');
                            $("#supplier_form").trigger("reset")
                        }

                    }).done(function () {
                });
            }else{
            }

        });

        //select all function
        selectAll("selectAllSupplier","chkSupplier");
        selectAll("selectAllSupplier","chkRepresentative");

        // END Supplier TABLE



        // BEGIN LISTING TABLE
        $('#listing-datatable').dataTable({
            autoWidth: false,
            language: {
                "sEmptyTable": "Nenhum registro encontrado",
                "sInfo": "Mostrando de _START_ até _END_ de _TOTAL_ registros",
                "sInfoEmpty": "Mostrando 0 até 0 de 0 registros",
                "sInfoFiltered": "(Filtrados de _MAX_ registros)",
                "sInfoPostFix": "",
                "sInfoThousands": ".",
                "sLengthMenu": "_MENU_ resultados por página",
                "sLoadingRecords": "Carregando...",
                "sProcessing": "Processando...",
                "sZeroRecords": "Nenhum registro encontrado",
                "sSearch": "Pesquisar",
                "oPaginate": {
                    "sNext": '<i class="fa fa-angle-right"></i>',
                    "sPrevious": '<i class="fa fa-angle-left"></i>',

                },
                "oAria": {
                    "sSortAscending": ": Ordenar colunas de forma ascendente",
                    "sSortDescending": ": Ordenar colunas de forma descendente"
                }
            },
            lengthMenu: [ [10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"] ],
            iDisplayLength: -1,
            responsive: true,
            dom: '<"top"<"pull-left"l><"pull-right"fB>><"table-scrollable"t><"bottom"ip><"clear">',
            buttons: [
                {
                    text: '',
                    className: 'datatable-plus-button ',
                    action: function ( e, dt, node, config ) {
                        $('#listingModal').modal('toggle');
                    }
                }
            ]
        } );

        $('#salvar_lista').on('click', function() {

            var $this = $(this);
            var lista = $('#lista').val();
            var descricao = $('#descricao').val();
            var tipo = $('#tipo').val();
            let types = [ "{{ listingTypes|join('","')|raw }}" ];

            var listingForm = $( "#list_form" );

            listingForm.validate({
                errorPlacement: function(){
                    return false;
                }

            });
            var validationState = listingForm.valid();

            if(validationState) {
                $.ajax({
                    url: "{{ path('post_api_listing') }}",
                    type: 'POST',
                    contentType: "application/json",
                    dataType: "json",
                    headers: {'Api-Token': token},
                    data:  JSON.stringify({
                        name: lista,
                        type: tipo,
                        listing_products: [],
                        representatives: [],
                        description: descricao
                    }),
                    success: function (response) {
                        console.log(response);
                        $('#listing-datatable').DataTable().row.add([
                            "<label class='mt-checkbox mt-checkbox-outline'><input type='checkbox' value='"+response.id+"' name='chkListing' data-products='[]'/><span></span></label>",
                            response.name,
                            response.description,
                            types[response.type],
                            0
                        ]).draw();
                        $('#listingModal').modal('toggle');
                        $("#list_form").trigger("reset");
                        $("#list_form div:not(.perm)").removeClass('typing');
                    },
                    error: function (error) {
                        alert(error.responseJSON.error.exception["0"].message);
                        $('#listingModal').modal('toggle');
                        $("#list_form").trigger("reset")
                        $("#list_form div:not(.perm)").removeClass('typing');
                    }
                });
            } else {
            }
        });

        //select all function
        selectAll("selectAllListing","chkListing");
        // END LISTING TABLE

        // BEGIN PRODUCTS TABLE
        $('#product-datatable').dataTable({
            autoWidth: false,
            paging: false,
            language: {
                "sEmptyTable": "Nenhum registro encontrado",
                "sInfo": "Mostrando de _START_ até _END_ de _TOTAL_ registros",
                "sInfoEmpty": "Mostrando 0 até 0 de 0 registros",
                "sInfoFiltered": "(Filtrados de _MAX_ registros)",
                "sInfoPostFix": "",
                "sInfoThousands": ".",
                "sLengthMenu": "_MENU_ resultados por página",
                "sLoadingRecords": "Carregando...",
                "sProcessing": "Processando...",
                "sZeroRecords": "Nenhum registro encontrado",
                "sSearch": "Pesquisar",
                "oPaginate": {
                    "sNext": '<i class="fa fa-angle-right"></i>',
                    "sPrevious": '<i class="fa fa-angle-left"></i>'
                },
                "oAria": {
                    "sSortAscending": ": Ordenar colunas de forma ascendente",
                    "sSortDescending": ": Ordenar colunas de forma descendente"
                }
            },
            iDisplayLength: -1,
            responsive: true,
            dom: '<"top"<"pull-left"l><"pull-right"fB>><"table-scrollable"t><"bottom"p><"clear">',
            buttons: [
                {
                    text: '',
                    className: 'datatable-plus-button ',
                    action: function ( e, dt, node, config ) {
                        $('#productModal').modal('toggle');
                    }
                }
            ]
        }).on('search.dt', function() {
            $(this).find("tr").removeClass('hidden');
        }).on('draw.dt', function() {
            if($('#product-datatable').DataTable().search() == '') {
                $('#product-datatable tbody tr input[type="checkbox"]:not(:checked)').each(function() {
                    $(this).parents('tr:first').addClass('hidden');
                });
            }
        });

        $('#salvar_produto').on('click', function() {
            var $this = $(this);

            var produto = $('#produto').val();
            var marca = $('#marca').val();
            var tipo = $('#tipo-produto').val();
            var codigo = $('#codigo').val();
            var unidade = $('#unidade').val();
            var peso = $('#peso').val();
            var descricao = $('#descricao-produto').val();


            var productForm = $( "#product_form" );

            productForm.validate({
                errorPlacement: function(){
                    return false;
                }
            });
            var validationState = productForm.valid();

            if(validationState) {

                $.ajax(
                    {
                        url: "{{ path('post_api_product') }}",
                        type: 'POST',
                        contentType: "application/json",
                        dataType: "json",
                        headers: {'Api-Token': token},
                        data:  JSON.stringify({
                            name: produto,
                            brand: marca,
                            type: tipo,
                            ean: codigo,
                            full_description: descricao,
                            quantity: peso,
                            unit: unidade
                        }),
                        success: function (response) {
                            console.log(response);
                            $('#product-datatable').DataTable().row.add([
                                "<label class='mt-checkbox mt-checkbox-outline'><input type='checkbox' value='"+response.id+"' name='chkProducts' onchange='changeChkProduct.call(this);' checked data-quotesuppliers/><span></span></label>",
                                "<input type='number' min='1' class='form-control quantidade' value='1'>",
                                response.name,
                                response.type,
                                response.brand,
                                response.unit,
                            ]).draw();
                            changeChkProduct();
                            $('#productModal').modal('toggle');
                            $("#product_form").trigger("reset");
                            $("#product_form div:not(.perm)").removeClass('typing');
                            $("#advance a").removeClass('disabled');
                            $("#advance").show();
                        },
                        error: function (error) {
                            alert(error.responseJSON.error.exception["0"].message);
                            $('#productModal').modal('toggle');
                            $("#product_form").trigger("reset")
                            $("#product_form div:not(.perm)").removeClass('typing');
                        }

                    }).done(function () {
                });
            }else{
            }

        });

        // END PRODUCTS TABLE

        selectAll("selectAllSendSupplier","chkSendSupplier");

        // FINISH QUOTE
        $('#save-quote').click(function() {
            saveQuote(1, false);
        });

        $('#presential-quote').click(function() {
            saveQuote(2, false);
        });

        $('#sent-suppliers').click(function() {
            $('#sendSupplier').modal('toggle');
        });

        $('#sendLinks').click(function() {
            saveQuote(1, true);
        });

        function set2Digits(number) {
            let numberString = "" + number;

            if(numberString.length == 2)
                return numberString;
            else
                return "0" + numberString;
        }

        function dateToATOM(date) {
            let tzOffset = date.getTimezoneOffset();
            let sign = (Math.sign(tzOffset) > 0)?"-":"+";
            let tzHours = tzOffset/60;
            let tzMinutes = tzOffset%60;

            return date.getFullYear() + "-" +
                set2Digits(date.getMonth() + 1) + "-" +
                set2Digits(date.getDate()) + "T" +
                set2Digits(date.getHours()) + ":" +
                set2Digits(date.getMinutes()) + ":00" +
                sign + set2Digits(tzHours) + ":" + set2Digits(tzMinutes);
        }

        function saveQuote(type, force) {
            var name = $("#cotacao").val();
            var paymentDate = $('#prazoRCA').val();
            if(paymentDate == "Outros") {
                paymentDate = $('#prazo').val();
            }

            var startDate = $("#beginsAtTimePicker").data("datetimepicker").getDate();
            startDate = dateToATOM(startDate);

            var endDate = $("#expiresAtTimePicker").data("datetimepicker").getDate();
            endDate = dateToATOM(endDate);

            var productsId = [];
            var suppliersId = [];

            $.each($('#supplier-datatable tr input:checked'), function(i, v){
                if($(this).val() == 'on')
                    return true;

                suppliersId.push({
                    id: $(this).data('suppid'),
                    representative: {
                        id: $(this).val()
                    },
                    quantity: 1,
                    price: 0
                });
            });

            $.each($('#product-datatable tr input:checked'), function(i, v){
                let $this = $(this);

                if($this.val() == 'on')
                    return true;

                let quoteProduct = {
                    product: { id: $this.val() },
                    quantity: $this.parents('tr:first').find('input.quantidade').val(),
                    winners: []
                };
                let quoteSuppliers = $this.data('quotesuppliers');

                if(quoteSuppliers == "") {
                    quoteProduct.quote_suppliers = suppliersId;
                } else {
                    quoteProduct.quote_suppliers = quoteSuppliers;
                }

                productsId.push(quoteProduct);
            });

            $.ajax({
                url: "{{ quote is defined?path('put_api_quote', {id: quote.id}):path('post_api_quote') }}",
                type: '{{ quote is defined?'PUT':'POST' }}',
                contentType: "application/json",
                dataType: "json",
                headers: {'Api-Token': token},
                data:  JSON.stringify({
                    name: name,
                    type: type,
                    begins_at: startDate,
                    expires_at: endDate,
                    send_to_supplier: false,
                    payment_date: paymentDate,
                    quote_products: productsId,
                    quote_suppliers: suppliersId,
                }),
                beforeSend: function() {
                    $('#save-quote, #sent-suppliers, #presential-quote').addClass('disabled');
                },
                success: function (response) {
                    if(force)
                        sendLink(response.id);
                    else
                        location.href = '{{ path('cotacoes') }}'
                },
                error: function (error) {
                    alert(error.responseJSON.error.exception["0"].message);
                },
                complete: function() {
                    $('#save-quote, #sent-suppliers, #presential-quote').removeClass('disabled');
                }
            });
        }

        function sendLink(quoteId) {
            let url = '{{ path('send_to_supplier_list', { id: 0 }) }}';
            let representatives = [];

            url = url.replace(0, quoteId);

            $('#sendSuppliersTable tbody input:checked').each(function(index, input) {
                representatives.push({
                    id: $(input).val()
                });
            });

            $.ajax({
                url: url,
                type: 'PATCH',
                headers: {'Api-Token': token},
                data: JSON.stringify(representatives),
                beforeSend: function() {
                    $('#sendLinks').addClass('disabled');
                },
                success: function(res) {
                    alert(res.message);
                },
                error: function(jsXHR) {
                    alert(jsXHR.responseJSON.message);
                },
                complete: function() {
                    $('#sendLinks').removeClass('disabled');
                }
            });
        }

        // END FINISH QUOTE
    </script>
{% endblock %}
